<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MyCareer Tools</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* Global styles and dark/light mode variables */
    :root {
      --bg: #0f172a;
      --text: #e2e8f0;
      --accent: #38bdf8;
      --section: #1e293b;
      --highlight: #fbbf24;
    }
    body.light-mode {
      --bg: #f8fafc;
      --text: #1e293b;
      --accent: #0ea5e9;
      --section: #e2e8f0;
      --highlight: #ca8a04;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 20px;
      transition: all 0.3s ease;
      overflow: hidden; /* Prevent body scroll, app-section handles it */
    }
    h1, h2, h3 {
      color: var(--accent);
      margin-bottom: 10px;
    }
    .menu, .app-section {
      display: none;
    }
    .active {
      display: block;
    }
    .app-section.active {
      display: block;
      max-height: 100vh;
      overflow-y: auto;
      scroll-behavior: smooth;
      scrollbar-color: var(--accent) var(--section);
      scrollbar-width: thin;
      padding-bottom: 50px; /* Ensure content is not cut off by scrollbar */
    }
    .app-section.active::-webkit-scrollbar {
      width: 10px;
    }
    .app-section.active::-webkit-scrollbar-track {
      background: var(--section);
    }
    .app-section.active::-webkit-scrollbar-thumb {
      background-color: var(--accent);
      border-radius: 5px;
      border: 2px solid var(--section);
    }
    .app-container {
      animation: fadeIn 0.5s ease-in-out;
      display: flex;
      flex-direction: row;
      gap: 20px;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    button {
      background: var(--accent);
      color: black;
      padding: 10px 20px;
      margin: 10px;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    button:hover {
      background: var(--highlight);
    }
    .file-label {
      display: inline-block;
      background: var(--highlight);
      color: black;
      padding: 10px 20px;
      margin: 10px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s ease;
    }
    .file-label:hover {
      background: gold;
    }
    #fileInput {
      display: none;
    }
    #space-bg {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: -1;
      background: radial-gradient(circle at center, #1e293b, #0f172a);
      overflow: hidden;
    }
    .particle {
      position: absolute;
      width: 2px;
      height: 2px;
      background: white;
      border-radius: 50%;
      animation: moveParticles linear infinite;
    }
    @keyframes moveParticles {
      0% { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(100vh); opacity: 0; }
    }

    /* Panel specific styles */
    .panel {
      flex: 1 1 300px;
      background: var(--section);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      min-width: 300px;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input[type="number"], select {
      padding: 8px;
      margin-top: 5px;
      width: 100%;
      border-radius: 5px;
      border: none;
      font-size: 16px;
      box-sizing: border-box;
      background: var(--bg);
      color: var(--text);
    }
    .result {
      font-weight: bold;
      font-size: 18px;
      color: var(--highlight);
      margin-top: 10px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .top-bar button {
      margin-left: 10px;
      margin-top: 0; /* Override default button margin */
      margin-bottom: 0;
    }
    .file-input {
      display: none;
    }

    /* Custom Checkbox (Toggle Switch) Styles */
    .checkbox-container {
      display: inline-block;
      position: relative;
      padding-left: 45px; /* Space for the custom checkbox */
      margin-bottom: 12px;
      cursor: pointer;
      font-size: 18px;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      font-weight: normal; /* Override bold from h3 */
      color: var(--text);
    }

    /* Hide the browser's default checkbox */
    .checkbox-container input {
      position: absolute;
      opacity: 0;
      cursor: pointer;
      height: 0;
      width: 0;
    }

    /* The slider (checkmark) */
    .checkmark {
      position: absolute;
      top: 0;
      left: 0;
      height: 26px;
      width: 40px;
      background-color: var(--bg);
      border-radius: 13px;
      transition: background-color 0.2s;
    }

    /* The slider handle */
    .checkmark:before {
      content: "";
      position: absolute;
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      border-radius: 50%;
      transition: transform 0.2s;
    }

    /* When the checkbox is checked, add a blue background */
    .checkbox-container input:checked + .checkmark {
      background-color: var(--accent);
    }

    /* Move the slider handle when checked */
    .checkbox-container input:checked + .checkmark:before {
      transform: translateX(14px);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .app-container {
        flex-direction: column;
      }
      .top-bar {
        flex-direction: column;
        align-items: flex-start;
      }
      .top-bar > div {
        margin-top: 10px;
      }
      button, .file-label {
        width: 100%;
        font-size: 1rem;
        margin: 5px 0;
      }
      pre {
        font-size: 0.8rem;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
    }
  </style>
</head>
<body onload="loadFromLocal()">
  <div id="space-bg"></div>

  <!-- Main Menu -->
  <div class="menu active" id="mainMenu">
    <h1>üèÄ MyCareer Simulators</h1>
    <label for="fileInput" class="file-label">üìÇ Import JSON</label>
    <input type="file" id="fileInput" accept=".json" />
    <button onclick="showApp('nba2k')">NBA 2K23 MyCareer Tool</button>
    <button onclick="showApp('bbgm')">BBGM MyCareer Upgrade Simulator</button>
    <button onclick="redirectToBBGM()"><i class="fas fa-chart-line"></i> Open BBGM</button>
    <a href="https://discord.gg/5nPgxUn3H2" target="_blank" style="text-decoration:none;">
      <button><i class="fab fa-discord"></i> Join BBGM Discord</button>
    </a>
    <button onclick="toggleDarkMode()">üåì Toggle Dark Mode</button>
    <button onclick="showManual()">üìö Show Manual</button>
  </div>

  <!-- NBA 2K23 App Section -->
  <div class="app-section" id="nba2kApp">
    <div class="top-bar">
      <h1>NBA 2K23 MyCareer Tool</h1>
      <div>
        <button onclick="exportData('nba2k')">üíæ Export JSON</button>
        <label>
          <input type="file" class="file-input" id="nba2k_importFile" accept=".json">
          <button onclick="document.getElementById('nba2k_importFile').click()">üìÇ Import JSON</button>
        </label>
        <button onclick="backToMenu()">‚¨Ö Back to Menu</button>
      </div>
    </div>
    <div class="app-container">
      <div class="panel">
        <h2>Points Bank</h2>
        <label>Total Points Bank:
          <input type="number" id="nba2k_manualTotalPoints" value="1000"></label>
        <div class="result">Total Points Bank: <span id="nba2k_pointsBankDisplay">1000</span></div>
      </div>

      <div class="panel">
        <h2>Bonus Multipliers</h2>
        <label>Game Result:
          <select id="nba2k_gameResult">
            <option value="">- Select Here -</option>
            <option value="win">Win</option>
            <option value="otwin">OT Win</option>
            <option value="lose">Lose</option>
            <option value="otlose">OT Lose</option>
          </select>
        </label>
        <div id="nba2k_otCountBox" style="display:none;">
          <label>Overtime Count (1‚Äì6):
            <input type="number" id="nba2k_otCount" min="1" max="6" value="1"></label>
        </div>
        <label>Opponent Type:
          <select id="nba2k_opponentType">
            <option value="">- Select Here -</option>
            <option value="1">Easy Opponent</option>
            <option value="1.25">Normal Opponent</option>
            <option value="1.5">Hard Opponent</option>
            <option value="1.75">1st in Conference</option>
            <option value="2">1st/2nd in League</option>
            <option value="3">All-Star Game</option>
          </select>
        </label>
        <label>Team Last Season:
          <select id="nba2k_teamHistory">
            <option value="">- Select Here -</option>
            <option value="1">Did Not Make Playoffs</option>
            <option value="1.25">1st Round</option>
            <option value="1.5">2nd Round</option>
            <option value="1.75">Semifinalist</option>
            <option value="1.9">Finalist</option>
            <option value="2">Defending Champions</option>
          </select>
        </label>
        <button onclick="toggleMultiplierInfo('nba2k')">‚ÑπÔ∏è Explanation</button>
        <div id="nba2k_multiplierInfo" style="display:none; margin-top:10px;">
          <p><strong>Game Result:</strong> Win √ó1.5, OT Win adds +0.1 per OT (max 6), OT Lose √ó1.25</p>
          <p><strong>Opponent:</strong> Easy√ó1, Normal√ó1.25, Hard√ó1.5, 1st in Conf√ó1.75, Top‚Äë2√ó2, All‚ÄëStar√ó3</p>
          <p><strong>Team History:</strong> No Playoffs√ó1, 1stRn√ó1.25, 2ndRn√ó1.5, Semis√ó1.75, Finals√ó1.9, Champs√ó2</p>
        </div>
        <label><input type="checkbox" id="nba2k_disablePointAdd"> Don't add to total bank</label>
      </div>

      <div class="panel">
        <h2>Game Stats</h2>
        <form id="nba2k_statsForm" onsubmit="event.preventDefault(); calculateTotalPoints('nba2k');">
          <label>Points (gpts): <input type="number" name="gpts" value="0"></label>
          <label>Rebounds (greb): <input type="number" name="greb" value="0"></label>
          <label>Assists (gast): <input type="number" name="gast" value="0"></label>
          <label>Steals (gstl): <input type="number" name="gstl" value="0"></label>
          <label>Blocks (gblk): <input type="number" name="gblk" value="0"></label>
          <label>2PT Made (g2pt): <input type="number" name="g2pt" value="0"></label>
          <label>3PT Made (g3pt): <input type="number" name="g3pt" value="0"></label>
          <label>Free Throws (gfts): <input type="number" name="gfts" value="0"></label>
          <label>Turnovers (gtov): <input type="number" name="gtov" value="0"></label>
          <label>Fouls (gfls): <input type="number" name="gfls" value="0"></label>
          <label>+/- Score (gpm): <input type="number" name="gpm" value="0"></label>
          <label>Minutes (gm): <input type="number" name="gm" value="0"></label>
          <label>Base Points Increase: <input type="number" id="nba2k_basePointsIncrease" value="0"></label>
          <button type="submit">Calculate Points Earned</button>
        </form>
        <div class="result">Points Earned: <span id="nba2k_pointsEarned">0</span></div>
      </div>

      <div class="panel">
        <h2>Attribute Upgrade Cost</h2>
        <div>
          <h3>
            <label class="checkbox-container">
              <input type="checkbox" id="nba2k_useOffense" checked>
              <span class="checkmark"></span>
              Offense
            </label>
          </h3>
          <label>Current Rating: <input type="number" id="nba2k_offenseCurrent" value="60"></label>
          <label>Target Rating: <input type="number" id="nba2k_offenseTarget" value="70"></label>
          <div class="result">Cost: <span id="nba2k_offenseCost">0</span></div>
        </div>

        <div>
          <h3>
            <label class="checkbox-container">
              <input type="checkbox" id="nba2k_useDefense" checked>
              <span class="checkmark"></span>
              Defense
            </label>
          </h3>
          <label>Current Rating: <input type="number" id="nba2k_defenseCurrent" value="60"></label>
          <label>Target Rating: <input type="number" id="nba2k_defenseTarget" value="70"></label>
          <div class="result">Cost: <span id="nba2k_defenseCost">0</span></div>
        </div>

        <div>
          <h3>
            <label class="checkbox-container">
              <input type="checkbox" id="nba2k_useAthletic" checked>
              <span class="checkmark"></span>
              Athleticism
            </label>
          </h3>
          <label>Current Rating: <input type="number" id="nba2k_athleticCurrent" value="60"></label>
          <label>Target Rating: <input type="number" id="nba2k_athleticTarget" value="70"></label>
          <div class="result">Cost: <span id="nba2k_athleticCost">0</span></div>
        </div>

        <div>
          <h3>
            <label class="checkbox-container">
              <input type="checkbox" id="nba2k_useMental" checked>
              <span class="checkmark"></span>
              Mental
            </label>
          </h3>
          <label>Current Rating: <input type="number" id="nba2k_mentalCurrent" value="60"></label>
          <label>Target Rating: <input type="number" id="nba2k_mentalTarget" value="70"></label>
          <div class="result">Cost: <span id="nba2k_mentalCost">0</span></div>
        </div>

        <button onclick="calculateAllUpgrades('nba2k')">Calculate All Upgrade Costs</button>
        <div class="result" id="nba2k_upgradeSummary"></div>
        <button onclick="confirmUpgrade('nba2k')">Confirm Upgrade</button>
        <label>Price Multiplier:
          <select id="nba2k_priceMultiplier">
            <option value="1">Not Valuable (1√ó)</option>
            <option value="2">Valuable (2√ó)</option>
            <option value="3">Very Valuable (3√ó)</option>
          </select>
        </label>
      </div>
    </div>
  </div>

  <!-- BBGM App Section -->
  <div class="app-section" id="bbgmApp">
    <div class="top-bar">
      <h1>BasketballGM MyCareer Tool</h1>
      <div>
        <button onclick="exportData('bbgm')">üíæ Export JSON</button>
        <label>
          <input type="file" class="file-input" id="bbgm_importFile" accept=".json">
          <button onclick="document.getElementById('bbgm_importFile').click()">üìÇ Import JSON</button>
        </label>
        <label>
            <input type="file" class="file-input" id="bbgm_playerImportFile" accept=".json" onchange="handleBBGMPlayerFile(event)">
            <button onclick="document.getElementById('bbgm_playerImportFile').click()">‚õπÔ∏è Export BBGM Player & Convert Points</button>
        </label>
        <button onclick="backToMenu()">‚¨Ö Back to Menu</button>
      </div>
    </div>
    <div class="app-container">
      <div class="panel">
        <h2>Points Bank</h2>
        <label>Total Points Bank:
          <input type="number" id="bbgm_manualTotalPoints" value="1000"></label>
        <div class="result">Total Points Bank: <span id="bbgm_pointsBankDisplay">1000</span></div>
      </div>

      <div class="panel">
        <h2>Bonus Multipliers</h2>
        <label>Regular Season Wins:
          <select id="bbgm_winsCategory">
            <option value="">- Select Here -</option>
            <option value="1">0-20 Wins (1√ó)</option>
            <option value="1.25">21-40 Wins (1.25√ó)</option>
            <option value="1.5">41-50 Wins (1.5√ó)</option>
            <option value="1.75">51-60 Wins (1.75√ó)</option>
            <option value="2">61+ Wins (2√ó)</option>
          </select>
        </label>
        <label>Playoff Performance:
          <select id="bbgm_playoffPerformance">
            <option value="">- Select Here -</option>
            <option value="1">Not in Playoffs (1√ó)</option>
            <option value="1.5">Play-in (1.5√ó)</option>
            <option value="1">Play-in Exit (1√ó)</option>
            <option value="1.15">1st Round Exit (1.15√ó)</option>
            <option value="1.35">2nd Round Exit (1.35√ó)</option>
            <option value="1.55">Conf. Finals Exit (1.55√ó)</option>
            <option value="1.75">Finals Exit (1.75√ó)</option>
            <option value="2">Champions (2√ó)</option>
          </select>
        </label>
        <button onclick="toggleMultiplierInfo('bbgm')">‚ÑπÔ∏è Explanation</button>
        <div id="bbgm_multiplierInfo" style="display:none; margin-top:10px;">
          <p><strong>Regular Season Wins:</strong> 0-20 (1√ó), 21-40 (1.25√ó), 41-50 (1.5√ó), 51-60 (1.75√ó), 61+ (2√ó)</p>
          <p><strong>Playoff Performance:</strong> Not in Playoffs (1√ó), Play-in (1.5√ó), 1st Round Exit (1.15√ó), 2nd Round Exit (1.35√ó), Conf. Finals Exit (1.55√ó), Finals Exit (1.75√ó), Champions (2√ó)</p>
        </div>
        <label><input type="checkbox" id="bbgm_disablePointAdd"> Don't add to total bank</label>
      </div>

      <div class="panel">
        <h2>Game Stats</h2>
        <form id="bbgm_statsForm" onsubmit="event.preventDefault(); calculateTotalPoints('bbgm');">
          <label>Points (gpts): <input type="number" name="gpts" value="0"></label>
          <label>Rebounds (greb): <input type="number" name="greb" value="0"></label>
          <label>Assists (gast): <input type="number" name="gast" value="0"></label>
          <label>Steals (gstl): <input type="number" name="gstl" value="0"></label>
          <label>Blocks (gblk): <input type="number" name="gblk" value="0"></label>
          <label>2PT Made (g2pt): <input type="number" name="g2pt" value="0"></label>
          <label>3PT Made (g3pt): <input type="number" name="g3pt" value="0"></label>
          <label>Free Throws (gfts): <input type="number" name="gfts" value="0"></label>
          <label>Turnovers (gtov): <input type="number" name="gtov" value="0"></label>
          <label>Fouls (gfls): <input type="number" name="gfls" value="0"></label>
          <label>+/- Score (gpm): <input type="number" name="gpm" value="0"></label>
          <label>Minutes (gm): <input type="number" name="gm" value="0"></label>
          <label>Base Points Increase: <input type="number" id="bbgm_basePointsIncrease" value="0"></label>
          <button type="submit">Calculate Points Earned</button>
        </form>
        <div class="result">Points Earned: <span id="bbgm_pointsEarned">0</span></div>
      </div>

      <div class="panel">
        <h2>Attribute Upgrade Cost</h2>
        <div>
          <h3>
            <label class="checkbox-container">
              <input type="checkbox" id="bbgm_useOffense" checked>
              <span class="checkmark"></span>
              Offensive
            </label>
          </h3>
          <label>Current Rating: <input type="number" id="bbgm_offenseCurrent" value="60"></label>
          <label>Target Rating: <input type="number" id="bbgm_offenseTarget" value="70"></label>
          <div class="result">Cost: <span id="bbgm_offenseCost">0</span></div>
        </div>

        <div>
          <h3>
            <label class="checkbox-container">
              <input type="checkbox" id="bbgm_useAthletic" checked>
              <span class="checkmark"></span>
              Athleticism
            </label>
          </h3>
          <label>Current Rating: <input type="number" id="bbgm_athleticCurrent" value="60"></label>
          <label>Target Rating: <input type="number" id="bbgm_athleticTarget" value="70"></label>
          <div class="result">Cost: <span id="bbgm_athleticCost">0</span></div>
        </div>

        <div>
          <h3>
            <label class="checkbox-container">
              <input type="checkbox" id="bbgm_useSkill" checked>
              <span class="checkmark"></span>
              Skill
            </label>
          </h3>
          <label>Current Rating: <input type="number" id="bbgm_skillCurrent" value="60"></label>
          <label>Target Rating: <input type="number" id="bbgm_skillTarget" value="70"></label>
          <div class="result">Cost: <span id="bbgm_skillCost">0</span></div>
        </div>

        <button onclick="calculateAllUpgrades('bbgm')">Calculate All Upgrade Costs</button>
        <div class="result" id="bbgm_upgradeSummary"></div>
        <button onclick="confirmUpgrade('bbgm')">Confirm Upgrade</button>
        <!-- Price Multiplier removed as per request -->
      </div>
    </div>
  </div>

  <!-- Manual Section -->
  <div class="app-section" id="manualApp">
    <div class="top-bar">
      <h1>üìö How to Use MyCareer Tools</h1>
      <button onclick="backToMenu()">‚¨Ö Back to Menu</button>
    </div>
    <div class="app-container">
      <div class="panel">
        <h2>General Usage</h2>
        <ul>
          <li><strong>Import/Export JSON:</strong> You can save and load your progress for both NBA 2K23 and BBGM simulators using the "Export JSON" and "Import JSON" buttons. This allows you to resume your work later or share your data.</li>
          <li><strong>Toggle Dark Mode:</strong> Switch between dark and light themes for a comfortable viewing experience.</li>
          <li>
            <label class="checkbox-container">
              <input type="checkbox" id="showTutorialOnStartup">
              <span class="checkmark"></span>
              Add tutorial when opening app (appears once)
            </label>
            <p style="font-size: 0.9em; margin-top: 5px; color: var(--text);">
              Check this box if you want this manual to automatically show up the next time you open the app. It will only appear once after checking.
            </p>
          </li>
        </ul>
      </div>

      <div class="panel">
        <h2>NBA 2K23 MyCareer Tool</h2>
        <ul>
          <li><strong>Points Bank:</strong> Manually adjust your total points.</li>
          <li><strong>Bonus Multipliers:</strong> Select game results, opponent type, and team history to calculate bonus points earned per game. An explanation is available by clicking the "‚ÑπÔ∏è Explanation" button.</li>
          <li><strong>Game Stats:</strong> Input your in-game statistics to calculate points earned from a single game.</li>
          <li><strong>Attribute Upgrade Cost:</strong>
            <ul>
              <li>Enter your "Current Rating" and "Target Rating" for Offense, Defense, Athleticism, and Mental attributes.</li>
              <li>Use the checkboxes to include/exclude specific attribute categories from the calculation.</li>
              <li>Click "Calculate All Upgrade Costs" to see the total cost and your points balance after upgrades.</li>
              <li>"Price Multiplier" allows you to adjust the cost based on the attribute's perceived value.</li>
              <li>"Confirm Upgrade" will deduct the calculated cost from your points bank.</li>
            </ul>
          </li>
        </ul>
      </div>

      <div class="panel">
        <h2>BBGM MyCareer Upgrade Simulator</h2>
        <ul>
          <li><strong>Points Bank:</strong> Manually adjust your total points.</li>
          <li><strong>Bonus Multipliers:</strong>
            <ul>
              <li><strong>Regular Season Wins:</strong> Select a category based on your team's total regular season wins to apply a multiplier to your earned points.</li>
              <li><strong>Playoff Performance:</strong> Choose your team's playoff outcome for another multiplier.</li>
              <li>An explanation of these multipliers is available via the "‚ÑπÔ∏è Explanation" button.</li>
            </ul>
          </li>
          <li><strong>Game Stats:</strong> Input your in-game statistics to calculate points earned from a single game.</li>
          <li><strong>Export BBGM Player & Convert Points:</strong> This special feature allows you to:
            <ol>
              <li>Click the "‚õπÔ∏è Export BBGM Player & Convert Points" button.</li>
              <li>Select a BBGM player JSON file from your computer.</li>
              <li>If the player has stats from multiple seasons, a modal will appear asking you to select which season (Regular Season or Playoffs) you want to convert.</li>
              <li>The selected season's stats (2PT, 3PT, FT, REB, AST, STL, BLK, TOV, PF, PM, GP, MIN) will be converted into points and added to your "Total Points Bank".</li>
            </ol>
          </li>
          <li><strong>Attribute Upgrade Cost:</strong>
            <ul>
              <li>Enter your "Current Rating" and "Target Rating" for Offensive, Athleticism, and Skill attributes.</li>
              <li>Use the checkboxes to include/exclude specific attribute categories.</li>
              <li>Click "Calculate All Upgrade Costs" to see the total cost and your points balance after upgrades.</li>
              <li>**Note:** The "Price Multiplier" is not used in the BBGM simulator. Costs are based on individual attribute values, with "valuable" attributes (3PT, Offensive IQ, Defensive IQ) having a 1.5x multiplier.</li>
              <li>"Confirm Upgrade" will deduct the calculated cost from your points bank.</li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Custom Modal for Season Selection -->
  <div id="seasonSelectModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1001; display:flex; align-items:center; justify-content:center;">
      <div style="background:var(--section); padding:20px; border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,0.7); text-align:center; max-width:90vw; max-height:80vh; overflow-y:auto;">
          <h2 style="color:var(--accent); margin-bottom:15px;">Select Season to Convert</h2>
          <div id="seasonList" style="display:flex; flex-wrap:wrap; justify-content:center; gap:10px;">
              <!-- Season buttons will be inserted here by JS -->
          </div>
          <button onclick="document.getElementById('seasonSelectModal').style.display='none';" style="margin-top:20px;">Cancel</button>
      </div>
  </div>

  <script>
    const VALUABLE_MULTIPLIER = 1.5; // Multiplier for valuable attributes (3pt, OIQ, DIQ)
    const PLAYOFF_POINTS_MULTIPLIER = 1.1; // New multiplier for playoff stats points

    // Define point values and upgrade costs for both apps
    const appData = {
      nba2k: {
        pointValues: {
          gpts: 2, greb: 5, gast: 5, gstl: 10, gblk: 10,
          g2pt: 2, g3pt: 3, gfts: 1, gtov: -2, gfls: -1, gpm: 5, gm: 1
        },
        upgradeCostPerPoint: {
          offense: r => (r < 60 ? 25 : r <= 79 ? 40 : r <= 89 ? 70 : r <= 94 ? 125 : 50),
          mental: r => (r < 60 ? 25 : r <= 79 ? 37 : r <= 89 ? 68 : r <= 94 ? 120 : 45),
          defense: r => (r < 60 ? 25 : r <= 79 ? 51 : r <= 89 ? 85 : r <= 94 ? 135 : 75),
          athletic: r => (r < 60 ? 30 : r <= 79 ? 65 : r <= 89 ? 105 : r <= 94 ? 155 : 100)
        },
        upgradeCategories: [
          { key: 'offense', useId: 'useOffense', baseMultiplier: 1.25 },
          { key: 'defense', useId: 'useDefense', baseMultiplier: 1.5 },
          { key: 'athletic', useId: 'useAthletic', baseMultiplier: 2.5 },
          { key: 'mental', useId: 'useMental', baseMultiplier: 2.0 }
        ]
      },
      bbgm: {
        // Point values for converting player stats to points
        statConversionPoints: {
            twoPointersMade: 2,
            threePointersMade: 3,
            freeThrowsMade: 1,
            reb: 1,
            ast: 1.5,
            stl: 2,
            blk: 2,
            tov: -1,
            pf: -0.5, // Using 'pf' from BBGM JSON
            pm: 0.2,
            gp: 1000,
            min: 0.1
        },
        // New multipliers based on season performance
        winsMultipliers: {
            '0-20': 1,
            '21-40': 1.25,
            '41-50': 1.5,
            '51-60': 1.75,
            '61+': 2
        },
        playoffMultipliers: {
            'not_in_playoffs': 1,
            'play_in': 1.5,
            'play_in_exit': 1,
            '1st_round_exit': 1.15,
            '2nd_round_exit': 1.35,
            'conf_finals_exit': 1.55,
            'finals_exit': 1.75,
            'champions': 2
        },
        // Upgrade costs per individual attribute
        upgradeCostPerAttribute: {
            // Athleticism: stre, spd, jmp, endu
            stre: r => (r < 60 ? 64 : r <= 79 ? 65 : r <= 89 ? 147 : r <= 94 ? 217 : 274),
            spd: r => (r < 60 ? 64 : r <= 79 ? 65 : r <= 89 ? 147 : r <= 94 ? 217 : 274),
            jmp: r => (r < 60 ? 64 : r <= 79 ? 65 : r <= 89 ? 147 : r <= 94 ? 217 : 274),
            endu: r => (r < 60 ? 64 : r <= 79 ? 65 : r <= 89 ? 147 : r <= 94 ? 217 : 274),

            // Offensive: ins, dnk, ft, fg, tp
            ins: r => (r < 60 ? 95 : r <= 79 ? 115 : r <= 89 ? 134 : r <= 94 ? 168 : 209),
            dnk: r => (r < 60 ? 95 : r <= 79 ? 115 : r <= 89 ? 134 : r <= 94 ? 168 : 209),
            ft: r => (r < 60 ? 95 : r <= 79 ? 115 : r <= 89 ? 134 : r <= 94 ? 168 : 209),
            fg: r => (r < 60 ? 95 : r <= 79 ? 115 : r <= 89 ? 134 : r <= 94 ? 168 : 209),
            tp: r => (r < 60 ? 95 : r <= 79 ? 115 : r <= 89 ? 134 : r <= 94 ? 168 : 209) * VALUABLE_MULTIPLIER, // Valuable attribute

            // Skill: oiq, diq, drb, pss, reb
            oiq: r => (r < 60 ? 75 : r <= 79 ? 120 : r <= 89 ? 157 : r <= 94 ? 234 : 347) * VALUABLE_MULTIPLIER, // Valuable attribute
            diq: r => (r < 60 ? 75 : r <= 79 ? 120 : r <= 89 ? 157 : r <= 94 ? 234 : 347) * VALUABLE_MULTIPLIER, // Valuable attribute
            drb: r => (r < 60 ? 75 : r <= 79 ? 120 : r <= 89 ? 157 : r <= 94 ? 234 : 347),
            pss: r => (r < 60 ? 75 : r <= 79 ? 120 : r <= 89 ? 157 : r <= 94 ? 234 : 347),
            reb: r => (r < 60 ? 75 : r <= 79 ? 120 : r <= 89 ? 157 : r <= 94 ? 234 : 347),
        },
        upgradeCategories: [
          { key: 'offense', useId: 'useOffense', attributes: ['ins', 'dnk', 'ft', 'fg', 'tp'] },
          { key: 'athletic', useId: 'useAthletic', attributes: ['stre', 'spd', 'jmp', 'endu'] },
          { key: 'skill', useId: 'useSkill', attributes: ['oiq', 'diq', 'drb', 'pss', 'reb'] }
        ]
      }
    };

    // Helper function to get elements for a specific app
    function getAppElements(appId) {
      const prefix = `${appId}_`;
      return {
        manualTotalPoints: document.getElementById(`${prefix}manualTotalPoints`),
        pointsBankDisplay: document.getElementById(`${prefix}pointsBankDisplay`),
        gameResult: document.getElementById(`${prefix}gameResult`), // Old, but still referenced in NBA2K
        otCountBox: document.getElementById(`${prefix}otCountBox`), // Old, but still referenced in NBA2K
        otCount: document.getElementById(`${prefix}otCount`), // Old, but still referenced in NBA2K
        opponentType: document.getElementById(`${prefix}opponentType`), // Old, but still referenced in NBA2K
        teamHistory: document.getElementById(`${prefix}teamHistory`), // Old, but still referenced in NBA2K
        winsCategory: document.getElementById(`${prefix}winsCategory`), // New for BBGM
        playoffPerformance: document.getElementById(`${prefix}playoffPerformance`), // New for BBGM
        multiplierInfo: document.getElementById(`${prefix}multiplierInfo`),
        disablePointAdd: document.getElementById(`${prefix}disablePointAdd`),
        statsForm: document.getElementById(`${prefix}statsForm`),
        basePointsIncrease: document.getElementById(`${prefix}basePointsIncrease`),
        pointsEarned: document.getElementById(`${prefix}pointsEarned`),
        upgradeSummary: document.getElementById(`${prefix}upgradeSummary`),
        priceMultiplier: document.getElementById(`${prefix}priceMultiplier`), // Still exists for NBA2K
        getUpgradeElements: (categoryKey) => {
          const categoryConfig = appData[appId].upgradeCategories.find(c => c.key === categoryKey);
          if (!categoryConfig) {
            console.error(`[getAppElements] Category config not found for key: ${categoryKey} in ${appId}`);
            return {};
          }
          const useCheckboxId = `${prefix}${categoryConfig.useId}`;
          return {
            use: document.getElementById(useCheckboxId),
            current: document.getElementById(`${prefix}${categoryKey}Current`),
            target: document.getElementById(`${prefix}${categoryKey}Target`),
            costDisplay: document.getElementById(`${prefix}${categoryKey}Cost`)
          };
        }
      };
    }

    // Function to attach all event listeners dynamically
    function attachEventListeners(appId) {
        const elements = getAppElements(appId);

        // Points Bank input
        if (elements.manualTotalPoints) {
            elements.manualTotalPoints.addEventListener('change', () => updatePointsBankDisplay(appId));
        }

        // Bonus Multipliers (NBA2K specific)
        if (appId === 'nba2k') {
            if (elements.gameResult) {
                elements.gameResult.addEventListener('change', () => {
                    toggleOTBox(appId);
                    calculateTotalPoints(appId);
                });
            }
            if (elements.otCount) {
                elements.otCount.addEventListener('change', () => calculateTotalPoints(appId));
            }
            if (elements.opponentType) {
                elements.opponentType.addEventListener('change', () => calculateTotalPoints(appId));
            }
            if (elements.teamHistory) {
                elements.teamHistory.addEventListener('change', () => calculateTotalPoints(appId));
            }
        } else if (appId === 'bbgm') {
            // New BBGM multipliers
            if (elements.winsCategory) {
                elements.winsCategory.addEventListener('change', () => calculateTotalPoints(appId));
            }
            if (elements.playoffPerformance) {
                elements.playoffPerformance.addEventListener('change', () => calculateTotalPoints(appId));
            }
        }

        if (elements.disablePointAdd) {
            elements.disablePointAdd.addEventListener('change', () => calculateTotalPoints(appId));
        }

        // Game Stats form inputs (using input event for live updates)
        if (elements.statsForm) {
            const statsInputs = elements.statsForm.querySelectorAll('input[type="number"]');
            statsInputs.forEach(input => {
                input.addEventListener('input', () => calculateTotalPoints(appId));
            });
        }
        if (elements.basePointsIncrease) {
            elements.basePointsIncrease.addEventListener('change', () => calculateTotalPoints(appId));
        }

        // Attribute Upgrade Cost inputs and checkboxes
        // Only attach for NBA2K if priceMultiplier exists
        if (appId === 'nba2k' && elements.priceMultiplier) {
            elements.priceMultiplier.addEventListener('change', () => calculateAllUpgrades(appId));
        }


        appData[appId].upgradeCategories.forEach(category => {
            const upgradeElements = elements.getUpgradeElements(category.key);
            if (upgradeElements.use) {
                upgradeElements.use.addEventListener('change', () => calculateAllUpgrades(appId));
            }
            if (upgradeElements.current) {
                upgradeElements.current.addEventListener('change', () => calculateAllUpgrades(appId));
            }
            if (upgradeElements.target) {
                upgradeElements.target.addEventListener('change', () => calculateAllUpgrades(appId));
            }
        });

        // Attach event listener for file inputs (Import JSON)
        const importFileInput = document.getElementById(`${appId}_importFile`);
        if (importFileInput) {
            importFileInput.addEventListener('change', (event) => importData(event, appId));
        }

        // Manual tutorial checkbox
        const showTutorialCheckbox = document.getElementById('showTutorialOnStartup');
        if (showTutorialCheckbox) {
            showTutorialCheckbox.addEventListener('change', (event) => {
                saveToLocal('showTutorialOnStartup', event.target.checked);
            });
        }
    }

    // Toggles dark mode for the entire body
    function toggleDarkMode() {
      document.body.classList.toggle('light-mode');
      saveToLocal('darkMode', document.body.classList.contains('light-mode'));
    }

    // Toggles the overtime count input box visibility (NBA2K only)
    function toggleOTBox(appId) {
      if (appId === 'nba2k') {
        const elements = getAppElements(appId);
        if (elements.otCountBox && elements.gameResult) {
          elements.otCountBox.style.display =
            elements.gameResult.value === "otwin" ? "block" : "none";
        }
      }
    }

    // Toggles the explanation for bonus multipliers
    function toggleMultiplierInfo(appId) {
      const elements = getAppElements(appId);
      const info = elements.multiplierInfo;
      if (info) {
        info.style.display = info.style.display === "none" ? "block" : "none";
      }
    }

    // Updates the displayed points bank value
    function updatePointsBankDisplay(appId) {
      const elements = getAppElements(appId);
      if (elements.pointsBankDisplay && elements.manualTotalPoints) {
        elements.pointsBankDisplay.innerText = parseInt(elements.manualTotalPoints.value) || 0;
      }
    }

    // Calculates points earned from game stats
    function calculateTotalPoints(appId) {
      const elements = getAppElements(appId);
      const appSpecificData = appData[appId];
      const form = elements.statsForm;
      let earned = 0;

      if (form) {
        for (let key in appSpecificData.pointValues) {
          const input = form[key];
          if (input) {
            earned += (parseInt(input.value) || 0) * appSpecificData.pointValues[key];
          }
        }
      }

      const baseIncrease = parseInt(elements.basePointsIncrease?.value || '0') || 0;
      earned += baseIncrease;

      let finalMultiplier = 1;

      if (appId === 'nba2k') {
          const result = elements.gameResult?.value || '';
          const opp = parseFloat(elements.opponentType?.value) || 1;
          const team = parseFloat(elements.teamHistory?.value) || 1;

          let gameResultMultiplier = 1;
          if (result === "win") gameResultMultiplier = 1.5;
          else if (result === "otwin") {
            const ot = Math.min(6, parseInt(elements.otCount?.value || '1') || 1);
            gameResultMultiplier = 1.5 + (0.1 * ot);
          } else if (result === "otlose") gameResultMultiplier = 1.25;

          finalMultiplier = gameResultMultiplier * opp * team;

      } else if (appId === 'bbgm') {
          const winsCategory = elements.winsCategory?.value || '';
          const playoffPerformance = elements.playoffPerformance?.value || '';

          const winsMultiplier = parseFloat(appSpecificData.winsMultipliers[winsCategory]) || 1;
          const playoffMultiplier = parseFloat(appSpecificData.playoffMultipliers[playoffPerformance]) || 1;

          finalMultiplier = winsMultiplier * playoffMultiplier;
      }


      const total = Math.round(earned * finalMultiplier);
      const bankInput = elements.manualTotalPoints;
      const currentBankValue = parseInt(bankInput?.value || '0') || 0;
      const newTotal = elements.disablePointAdd?.checked ? currentBankValue : currentBankValue + total;

      if (bankInput) bankInput.value = newTotal;
      if (elements.pointsBankDisplay) elements.pointsBankDisplay.innerText = newTotal;
      if (elements.pointsEarned) elements.pointsEarned.innerText = total;

      saveCurrentAppData(appId);
    }

    // Calculates total cost for attribute upgrades
    function calculateAllUpgrades(appId) {
      const elements = getAppElements(appId);
      const appSpecificData = appData[appId];

      let totalCost = 0;
      const bank = parseInt(elements.manualTotalPoints?.value || '0') || 0;
      // Price multiplier only for NBA2K
      const priceMultiplier = (appId === 'nba2k' ? parseFloat(elements.priceMultiplier?.value) : 1) || 1;

      for (let category of appSpecificData.upgradeCategories) {
        const upgradeElements = elements.getUpgradeElements(category.key);
        const current = parseInt(upgradeElements.current?.value || '0');
        const target = parseInt(upgradeElements.target?.value || '0');
        const display = upgradeElements.costDisplay;

        const useCategory = upgradeElements.use ? upgradeElements.use.checked : true;

        if (!useCategory) {
          if (display) display.innerText = "Ignored";
          continue;
        }

        const actualCurrent = isNaN(current) ? 60 : current;
        const actualTarget = isNaN(target) ? 70 : target;

        if (actualCurrent >= actualTarget) {
          if (display) display.innerText = "Invalid";
          continue;
        }

        let categoryTotalCost = 0;

        if (appId === 'nba2k') {
            // NBA2K logic: uses upgradeCostPerPoint directly for the category
            if (typeof appSpecificData.upgradeCostPerPoint[category.key] === 'function') {
                for (let i = actualCurrent + 1; i <= actualTarget; i++) {
                    let baseCost = appSpecificData.upgradeCostPerPoint[category.key](i);
                    categoryTotalCost += baseCost * category.baseMultiplier * priceMultiplier;
                }
            } else {
                console.error(`Error: upgradeCostPerPoint for category '${category.key}' is not a function for NBA2K.`);
                if (display) display.innerText = "Error";
                continue;
            }
        } else if (appId === 'bbgm') {
            // BBGM logic: sums costs of individual attributes within the category
            if (category.attributes && category.attributes.length > 0) {
                for (const attrKey of category.attributes) {
                    if (typeof appSpecificData.upgradeCostPerAttribute[attrKey] === 'function') {
                        for (let i = actualCurrent + 1; i <= actualTarget; i++) {
                            let baseCost = appSpecificData.upgradeCostPerAttribute[attrKey](i);
                            categoryTotalCost += baseCost;
                        }
                    } else {
                        console.error(`Error: upgradeCostPerAttribute for attribute '${attrKey}' is not a function for BBGM.`);
                        // If an individual attribute function is missing, mark category as error
                        categoryTotalCost = NaN; // Indicate error
                        break;
                    }
                }
            } else {
                console.warn(`BBGM category '${category.key}' has no defined attributes.`);
            }

            if (isNaN(categoryTotalCost)) {
                if (display) display.innerText = "Error";
                continue;
            }
        }


        if (display) display.innerText = Math.round(categoryTotalCost);
        totalCost += categoryTotalCost;
      }

      const summary = elements.upgradeSummary;
      if (summary) {
        summary.innerHTML = `
          Total Upgrade Cost: ${Math.round(totalCost)}<br>
          Points Before Upgrade: ${bank}<br>
          Points After Upgrade: ${bank - Math.round(totalCost)}
        `;
        summary.dataset.totalCost = Math.round(totalCost);
      }

      saveCurrentAppData(appId);
    }

    // Confirms and applies the attribute upgrade cost
    function confirmUpgrade(appId) {
      const elements = getAppElements(appId);
      const cost = parseInt(elements.upgradeSummary?.dataset.totalCost || "0");
      const bankInput = elements.manualTotalPoints;
      const currentPoints = parseInt(bankInput?.value || '0') || 0;

      if (cost > currentPoints) {
        showCustomAlert("Not enough points for upgrade!");
        return;
      }

      if (bankInput) bankInput.value = currentPoints - cost;
      if (elements.pointsBankDisplay) elements.pointsBankDisplay.innerText = bankInput.value;
      showCustomAlert("Upgrade applied!");

      saveCurrentAppData(appId);
    }

    // Custom alert function (replaces window.alert)
    function showCustomAlert(message) {
      const alertBox = document.createElement('div');
      alertBox.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--section);
        color: var(--text);
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0,0,0,0.7);
        z-index: 1000;
        text-align: center;
        max-width: 80vw;
      `;
      alertBox.innerHTML = `
        <p>${message}</p>
        <button onclick="this.parentNode.remove()" style="margin-top: 15px; background: var(--accent); color: black;">OK</button>
      `;
      document.body.appendChild(alertBox);
    }

    // Exports current app data to a JSON file
    function exportData(appId) {
      const elements = getAppElements(appId);
      const data = {
        app: appId,
        totalPoints: elements.manualTotalPoints?.value || '0',
        disablePointAdd: elements.disablePointAdd?.checked || false,
        basePointsIncrease: elements.basePointsIncrease?.value || '0',
        stats: {},
        upgrade: {}
      };

      // NBA2K specific data
      if (appId === 'nba2k') {
          data.gameResult = elements.gameResult?.value || '';
          data.otCount = elements.otCount?.value || '1';
          data.opponentType = elements.opponentType?.value || '';
          data.teamHistory = elements.teamHistory?.value || '';
          if (elements.priceMultiplier) {
              data.upgrade.priceMultiplier = elements.priceMultiplier.value;
          }
      }
      // BBGM specific data
      else if (appId === 'bbgm') {
          data.winsCategory = elements.winsCategory?.value || '';
          data.playoffPerformance = elements.playoffPerformance?.value || '';
      }


      const statsForm = elements.statsForm;
      if (statsForm) {
        for (let i = 0; i < statsForm.elements.length; i++) {
          const el = statsForm.elements[i];
          if (el.name && el.type !== 'submit') {
            data.stats[el.name] = el.value;
          }
        }
      }

      appData[appId].upgradeCategories.forEach(category => {
        const upgradeElements = elements.getUpgradeElements(category.key);
        data.upgrade[category.key] = {
          current: upgradeElements.current?.value || '0',
          target: upgradeElements.target?.value || '0',
          use: upgradeElements.use ? upgradeElements.use.checked : true
        };
      });

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `${appId}_save.json`;
      link.click();
      URL.revokeObjectURL(link.href);
    }

    // Imports data from a JSON file
    function importData(event, targetAppId) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = JSON.parse(e.target.result);
          if (data.app !== targetAppId) {
            showCustomAlert(`This file is for ${data.app.toUpperCase()} and cannot be imported into ${targetAppId.toUpperCase()}.`);
            return;
          }

          const elements = getAppElements(targetAppId);

          if (elements.manualTotalPoints) elements.manualTotalPoints.value = data.totalPoints || 0;
          if (elements.disablePointAdd) elements.disablePointAdd.checked = data.disablePointAdd || false;
          if (elements.basePointsIncrease) elements.basePointsIncrease.value = data.basePointsIncrease || 0;

          // NBA2K specific imports
          if (targetAppId === 'nba2k') {
              if (elements.gameResult) elements.gameResult.value = data.gameResult || '';
              if (elements.otCount) elements.otCount.value = data.otCount || 1;
              if (elements.opponentType) elements.opponentType.value = data.opponentType || '';
              if (elements.teamHistory) elements.teamHistory.value = data.teamHistory || '';
              if (elements.priceMultiplier) elements.priceMultiplier.value = data.upgrade.priceMultiplier || '1';
          }
          // BBGM specific imports
          else if (targetAppId === 'bbgm') {
              if (elements.winsCategory) elements.winsCategory.value = data.winsCategory || '';
              if (elements.playoffPerformance) elements.playoffPerformance.value = data.playoffPerformance || '';
          }


          const statsForm = elements.statsForm;
          if (statsForm) {
            for (let key in data.stats) {
              if (statsForm[key]) {
                statsForm[key].value = data.stats[key];
              }
            }
          }

          appData[targetAppId].upgradeCategories.forEach(category => {
            const upgradeElements = elements.getUpgradeElements(category.key);
            const loadedUpgrade = data.upgrade[category.key];
            if (loadedUpgrade) {
              if (upgradeElements.current) upgradeElements.current.value = loadedUpgrade.current;
              if (upgradeElements.target) upgradeElements.target.value = loadedUpgrade.target;
              if (upgradeElements.use) {
                  upgradeElements.use.checked = loadedUpgrade.use;
              }
            }
          });

          toggleOTBox(targetAppId);
          updatePointsBankDisplay(targetAppId);
          calculateTotalPoints(targetAppId);
          calculateAllUpgrades(targetAppId);

          saveCurrentAppData(targetAppId);
          showCustomAlert("Data imported successfully!");

        } catch (err) {
          showCustomAlert("Invalid file format or data structure.");
          console.error("Import error:", err);
        }
      };
      reader.readAsText(file);
    }

    // Handles the main menu file input (for importing JSON)
    function handleFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = e => {
            try {
                const data = JSON.parse(e.target.result);
                // Determine which app the data belongs to and load it
                if (data.app === 'nba2k' || data.app === 'bbgm') {
                    showApp(data.app); // Switch to the correct app
                    // Delay import slightly to ensure app elements are rendered
                    setTimeout(() => importData({ target: { files: [file] } }, data.app), 50);
                } else {
                    showCustomAlert("The imported JSON file does not contain valid app data (nba2k or bbgm).");
                }
            } catch (err) {
                showCustomAlert("Invalid file format or data structure.");
                console.error("Import error:", err);
            }
        };
        reader.readAsText(file);
    }

    // BBGM Specific: Handles importing player JSON file and converting stats to points
    async function handleBBGMPlayerFile(event) {
        const file = event.target.files[0];
        if (!file) {
            // Important: Clear the input even if no file was selected, in case of phantom change event
            event.target.value = ''; // Clear the input to prevent re-triggering on future loads
            return;
        }

        const reader = new FileReader();
        reader.onload = async e => {
            try {
                const playerData = JSON.parse(e.target.result);

                if (!playerData.players || playerData.players.length === 0 || !playerData.players[0].stats) {
                    showCustomAlert("Invalid BBGM player file: Missing player stats data.");
                    return;
                }

                const playerStats = playerData.players[0].stats;
                
                // Group stats by season and calculate combined points
                const seasonsData = {};
                playerStats.forEach(statEntry => {
                    const season = statEntry.season;
                    if (!seasonsData[season]) {
                        seasonsData[season] = {
                            regularSeason: null,
                            playoffs: null,
                            combinedPoints: 0
                        };
                    }
                    if (statEntry.playoffs === false) {
                        seasonsData[season].regularSeason = statEntry;
                    } else if (statEntry.playoffs === true) {
                        seasonsData[season].playoffs = statEntry;
                    }
                });

                const availableSeasons = Object.keys(seasonsData).sort((a, b) => parseInt(a) - parseInt(b));
                
                // Calculate combined points for each season
                availableSeasons.forEach(season => {
                    let seasonTotalPoints = 0;
                    if (seasonsData[season].regularSeason) {
                        seasonTotalPoints += calculatePointsFromBBGMStats(seasonsData[season].regularSeason);
                    }
                    if (seasonsData[season].playoffs) {
                        seasonTotalPoints += calculatePointsFromBBGMStats(seasonsData[season].playoffs) * PLAYOFF_POINTS_MULTIPLIER;
                    }
                    seasonsData[season].combinedPoints = Math.round(seasonTotalPoints); // Round combined points
                });

                let selectedPoints = null;

                if (availableSeasons.length === 1) {
                    selectedPoints = seasonsData[availableSeasons[0]].combinedPoints;
                } else if (availableSeasons.length > 1) {
                    // Show modal for season selection, passing combined points
                    selectedPoints = await showSeasonSelectModal(availableSeasons.map(s => ({
                        season: parseInt(s),
                        points: seasonsData[s].combinedPoints
                    })));
                }

                if (selectedPoints !== null) { // Check for null, as 0 points is valid
                    const elements = getAppElements('bbgm');
                    const currentBank = parseInt(elements.manualTotalPoints.value) || 0;
                    const newBank = currentBank + selectedPoints;
                    elements.manualTotalPoints.value = newBank;
                    updatePointsBankDisplay('bbgm');
                    calculateTotalPoints('bbgm'); // Recalculate game points display
                    calculateAllUpgrades('bbgm'); // Recalculate upgrades based on new bank

                    showCustomAlert(`Successfully converted stats to ${selectedPoints} points! Total bank: ${newBank}`);
                    saveCurrentAppData('bbgm');
                } else {
                    showCustomAlert("No season selected or valid stats found for conversion.");
                }

            } catch (err) {
                showCustomAlert("Error processing BBGM player file: " + err.message);
                console.error("BBGM Player File Import Error:", err);
            } finally {
                // Always clear the file input value after processing, regardless of success or error
                event.target.value = '';
            }
        };
        reader.readAsText(file);
    }

    // Displays a modal for season selection and returns the selected points
    function showSeasonSelectModal(seasonsWithPoints) {
        return new Promise(resolve => {
            const modal = document.getElementById('seasonSelectModal');
            const seasonListDiv = document.getElementById('seasonList');
            seasonListDiv.innerHTML = ''; // Clear previous buttons

            seasonsWithPoints.forEach(seasonData => {
                const button = document.createElement('button');
                button.innerText = `Season ${seasonData.season} (Total: ${seasonData.points} points)`;
                button.onclick = () => {
                    modal.style.display = 'none';
                    resolve(seasonData.points);
                };
                seasonListDiv.appendChild(button);
            });

            // Add a cancel button to the modal
            const cancelButton = document.createElement('button');
            cancelButton.innerText = 'Cancel';
            cancelButton.onclick = () => {
                modal.style.display = 'none';
                resolve(null); // Resolve with null if cancelled
            };
            seasonListDiv.appendChild(cancelButton); // Append to seasonListDiv, not modal directly

            modal.style.display = 'flex'; // Show the modal
        });
    }

    // Calculates points from BBGM player stats
    function calculatePointsFromBBGMStats(stats) {
        const conversion = appData.bbgm.statConversionPoints;
        let totalPoints = 0;

        const twoPointersMade = (stats.fg || 0) - (stats.tp || 0);

        totalPoints += (twoPointersMade * conversion.twoPointersMade);
        totalPoints += (stats.tp || 0) * conversion.threePointersMade;
        totalPoints += (stats.ft || 0) * conversion.freeThrowsMade;

        totalPoints += (stats.reb || 0) * conversion.reb;
        totalPoints += (stats.ast || 0) * conversion.ast;
        totalPoints += (stats.stl || 0) * conversion.stl;
        totalPoints += (stats.blk || 0) * conversion.blk;
        totalPoints += (stats.tov || 0) * conversion.tov;
        totalPoints += (stats.pf || 0) * conversion.pf; // Use 'pf' from JSON
        totalPoints += (stats.pm || 0) * conversion.pm;
        totalPoints += (stats.gp || 0) * conversion.gp;
        totalPoints += (stats.min || 0) * conversion.min;

        return totalPoints; // Do not round here, as playoff multiplier needs to be applied first
    }


    // Shows the selected app section and hides others
    function showApp(appId) {
      document.getElementById('mainMenu')?.classList.remove('active');
      document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
      document.getElementById(appId + 'App')?.classList.add('active');
      saveToLocal('activeApp', appId);

      loadAppData(appId);
    }

    // Shows the manual section
    function showManual() {
      document.getElementById('mainMenu')?.classList.remove('active');
      document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
      document.getElementById('manualApp')?.classList.add('active');
      // No need to save activeApp for manual, as it's a temporary view
    }

    // Returns to the main menu
    function backToMenu() {
      document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
      document.getElementById('mainMenu')?.classList.add('active');
      localStorage.removeItem('mycareer_activeApp');
    }

    // Redirects to BBGM website
    function redirectToBBGM() {
      window.open("https://play.basketball-gm.com/", "_blank");
    }

    // Saves a key-value pair to local storage
    function saveToLocal(key, value) {
      localStorage.setItem('mycareer_' + key, JSON.stringify(value));
    }

    // Loads a key-value pair from local storage
    function loadFromLocal(key) {
      try {
        const item = localStorage.getItem('mycareer_' + key);
        return item ? JSON.parse(item) : null;
      } catch (e) {
        console.error("Error parsing localStorage item:", key, e);
        return null;
      }
    }

    // Saves all current data for the active app
    function saveCurrentAppData(appId) {
      const elements = getAppElements(appId);
      const data = {
        totalPoints: elements.manualTotalPoints?.value || '0',
        disablePointAdd: elements.disablePointAdd?.checked || false,
        basePointsIncrease: elements.basePointsIncrease?.value || '0',
        stats: {},
        upgrade: {}
      };

      // NBA2K specific data
      if (appId === 'nba2k') {
          data.gameResult = elements.gameResult?.value || '';
          data.otCount = elements.otCount?.value || '1';
          data.opponentType = elements.opponentType?.value || '';
          data.teamHistory = elements.teamHistory?.value || '';
          if (elements.priceMultiplier) {
              data.upgrade.priceMultiplier = elements.priceMultiplier.value;
          }
      }
      // BBGM specific data
      else if (appId === 'bbgm') {
          data.winsCategory = elements.winsCategory?.value || '';
          data.playoffPerformance = elements.playoffPerformance?.value || '';
      }


      const statsForm = elements.statsForm;
      if (statsForm) {
        for (let i = 0; i < statsForm.elements.length; i++) {
          const el = statsForm.elements[i];
          if (el.name && el.type !== 'submit') {
            data.stats[el.name] = el.value;
          }
        }
      }

      appData[appId].upgradeCategories.forEach(category => {
        const upgradeElements = elements.getUpgradeElements(category.key);
        data.upgrade[category.key] = {
          current: upgradeElements.current?.value || '0',
          target: upgradeElements.target?.value || '0',
          use: upgradeElements.use ? upgradeElements.use.checked : true
        };
      });

      saveToLocal(`data_${appId}`, data);
    }

    // Loads all data for a specific app into its fields
    function loadAppData(appId) {
      const data = loadFromLocal(`data_${appId}`);
      const elements = getAppElements(appId);

      // Apply loaded data or defaults
      if (elements.manualTotalPoints) elements.manualTotalPoints.value = data?.totalPoints || 1000;
      if (elements.disablePointAdd) elements.disablePointAdd.checked = data?.disablePointAdd || false;
      if (elements.basePointsIncrease) elements.basePointsIncrease.value = data?.basePointsIncrease || 0;

      // NBA2K specific loads
      if (appId === 'nba2k') {
          if (elements.gameResult) elements.gameResult.value = data?.gameResult || '';
          if (elements.otCount) elements.otCount.value = data?.otCount || 1;
          if (elements.opponentType) elements.opponentType.value = data?.opponentType || '';
          if (elements.teamHistory) elements.teamHistory.value = data?.teamHistory || '';
          if (elements.priceMultiplier) elements.priceMultiplier.value = data?.upgrade?.priceMultiplier || '1';
      }
      // BBGM specific loads
      else if (appId === 'bbgm') {
          if (elements.winsCategory) elements.winsCategory.value = data?.winsCategory || '';
          if (elements.playoffPerformance) elements.playoffPerformance.value = data?.playoffPerformance || '';
      }


      // Populate stats form
      const statsForm = elements.statsForm;
      if (statsForm && data?.stats) {
        for (let key in data.stats) {
          if (statsForm[key]) {
            statsForm[key].value = data.stats[key];
          }
        }
      } else if (statsForm) {
        statsForm.reset(); // Reset if no data
      }

      // Populate upgrade attributes
      appData[appId].upgradeCategories.forEach(category => {
        const upgradeElements = elements.getUpgradeElements(category.key);
        const loadedUpgrade = data?.upgrade?.[category.key]; // Use optional chaining
        if (loadedUpgrade) {
          if (upgradeElements.current) upgradeElements.current.value = loadedUpgrade.current;
          if (upgradeElements.target) upgradeElements.target.value = loadedUpgrade.target;
          if (upgradeElements.use) {
              upgradeElements.use.checked = loadedUpgrade.use;
          }
        } else {
            // Reset to default if no loaded data for this category
            if (upgradeElements.current) upgradeElements.current.value = 60;
            if (upgradeElements.target) upgradeElements.target.value = 70;
            if (upgradeElements.use) upgradeElements.use.checked = true;
        }
      });

      // Trigger calculations to update displays
      toggleOTBox(appId);
      updatePointsBankDisplay(appId);
      calculateTotalPoints(appId);
      calculateAllUpgrades(appId);
    }

    // Initial load on page load
    window.onload = function() {
      const showTutorialSetting = loadFromLocal('showTutorialOnStartup');
      const activeApp = loadFromLocal('activeApp');

      // If tutorial is set to show on startup, display it and then turn off the setting
      if (showTutorialSetting === true) {
        showManual();
        saveToLocal('showTutorialOnStartup', false); // Turn off for next time
      } else if (activeApp) {
        showApp(activeApp);
      } else {
        document.getElementById('mainMenu')?.classList.add('active');
      }

      const isLightMode = loadFromLocal('darkMode');
      if (isLightMode) {
        document.body.classList.add('light-mode');
      }

      // Attach event listeners for both apps
      attachEventListeners('nba2k');
      attachEventListeners('bbgm');

      // Initialize the state of the tutorial checkbox
      const showTutorialCheckbox = document.getElementById('showTutorialOnStartup');
      if (showTutorialCheckbox) {
          showTutorialCheckbox.checked = (loadFromLocal('showTutorialOnStartup') === true);
      }


      // Generate background particles
      for (let i = 0; i < 100; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.left = Math.random() * 100 + 'vw';
        p.style.top = Math.random() * -100 + 'vh';
        p.style.animationDuration = (5 + Math.random() * 10) + 's';
        document.getElementById('space-bg')?.appendChild(p);
      }
    };
  </script>
</body>
</html>
