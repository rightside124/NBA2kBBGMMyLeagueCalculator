<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MyCareer Tools</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* Global styles and dark/light mode variables */
    :root {
      --bg: #0f172a;
      --text: #e2e8f0;
      --accent: #38bdf8;
      --section: #1e293b;
      --highlight: #fbbf24;
    }
    body.light-mode {
      --bg: #f8fafc;
      --text: #1e293b;
      --accent: #0ea5e9;
      --section: #e2e8f0;
      --highlight: #ca8a04;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 20px;
      transition: all 0.3s ease;
      overflow: hidden; /* Prevent body scroll, app-section handles it */
    }
    h1, h2, h3 {
      color: var(--accent);
      margin-bottom: 10px;
    }
    .menu, .app-section {
      display: none;
    }
    .active {
      display: block;
    }
    .app-section.active {
      display: block;
      max-height: 100vh;
      overflow-y: auto;
      scroll-behavior: smooth;
      scrollbar-color: var(--accent) var(--section);
      scrollbar-width: thin;
      padding-bottom: 50px; /* Ensure content is not cut off by scrollbar */
    }
    .app-section.active::-webkit-scrollbar {
      width: 10px;
    }
    .app-section.active::-webkit-scrollbar-track {
      background: var(--section);
    }
    .app-section.active::-webkit-scrollbar-thumb {
      background-color: var(--accent);
      border-radius: 5px;
      border: 2px solid var(--section);
    }
    .app-container {
      animation: fadeIn 0.5s ease-in-out;
      display: flex;
      flex-direction: row;
      gap: 20px;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    button {
      background: var(--accent);
      color: black;
      padding: 10px 20px;
      margin: 10px;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    button:hover {
      background: var(--highlight);
    }
    .file-label {
      display: inline-block;
      background: var(--highlight);
      color: black;
      padding: 10px 20px;
      margin: 10px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s ease;
    }
    .file-label:hover {
      background: gold;
    }
    #fileInput {
      display: none;
    }
    #space-bg {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: -1;
      background: radial-gradient(circle at center, #1e293b, #0f172a);
      overflow: hidden;
    }
    .particle {
      position: absolute;
      width: 2px;
      height: 2px;
      background: white;
      border-radius: 50%;
      animation: moveParticles linear infinite;
    }
    @keyframes moveParticles {
      0% { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(100vh); opacity: 0; }
    }

    /* Panel specific styles */
    .panel {
      flex: 1 1 300px;
      background: var(--section);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      min-width: 300px;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input[type="number"], select {
      padding: 8px;
      margin-top: 5px;
      width: 100%;
      border-radius: 5px;
      border: none;
      font-size: 16px;
      box-sizing: border-box;
      background: var(--bg);
      color: var(--text);
    }
    .result {
      font-weight: bold;
      font-size: 18px;
      color: var(--highlight);
      margin-top: 10px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .top-bar button {
      margin-left: 10px;
      margin-top: 0; /* Override default button margin */
      margin-bottom: 0;
    }
    .file-input {
      display: none;
    }

    /* Custom Checkbox (Toggle Switch) Styles */
    .checkbox-container {
      display: inline-block;
      position: relative;
      padding-left: 45px; /* Space for the custom checkbox */
      margin-bottom: 12px;
      cursor: pointer;
      font-size: 18px;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      font-weight: normal; /* Override bold from h3 */
      color: var(--text);
    }

    /* Hide the browser's default checkbox */
    .checkbox-container input {
      position: absolute;
      opacity: 0;
      cursor: pointer;
      height: 0;
      width: 0;
    }

    /* The slider (checkmark) */
    .checkmark {
      position: absolute;
      top: 0;
      left: 0;
      height: 26px;
      width: 40px;
      background-color: var(--bg);
      border-radius: 13px;
      transition: background-color 0.2s;
    }

    /* The slider handle */
    .checkmark:before {
      content: "";
      position: absolute;
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      border-radius: 50%;
      transition: transform 0.2s;
    }

    /* When the checkbox is checked, add a blue background */
    .checkbox-container input:checked + .checkmark {
      background-color: var(--accent);
    }

    /* Move the slider handle when checked */
    .checkbox-container input:checked + .checkmark:before {
      transform: translateX(14px);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .app-container {
        flex-direction: column;
      }
      .top-bar {
        flex-direction: column;
        align-items: flex-start;
      }
      .top-bar > div {
        margin-top: 10px;
      }
      button, .file-label {
        width: 100%;
        font-size: 1rem;
        margin: 5px 0;
      }
      pre {
        font-size: 0.8rem;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
    }
  </style>
</head>
<body onload="loadFromLocal()">
  <div id="space-bg"></div>

  <!-- Main Menu -->
  <div class="menu active" id="mainMenu">
    <h1>üèÄ MyCareer Simulators</h1>
    <label for="fileInput" class="file-label">üìÇ Import JSON</label>
    <input type="file" id="fileInput" accept=".json" onchange="handleFile(event)" />
    <button onclick="showApp('nba2k')">NBA 2K23 MyCareer Tool</button>
    <button onclick="showApp('bbgm')">BBGM MyCareer Upgrade Simulator</button>
    <button onclick="redirectToBBGM()"><i class="fas fa-chart-line"></i> Open BBGM</button>
    <a href="https://discord.gg/5nPgxUn3H2" target="_blank" style="text-decoration:none;">
      <button><i class="fab fa-discord"></i> Join BBGM Discord</button>
    </a>
    <button onclick="toggleDarkMode()">üåì Toggle Dark Mode</button>
  </div>

  <!-- NBA 2K23 App Section -->
  <div class="app-section" id="nba2kApp">
    <div class="top-bar">
      <h1>NBA 2K23 MyCareer Tool</h1>
      <div>
        <button onclick="exportData('nba2k')">üíæ Export JSON</button>
        <label>
          <input type="file" class="file-input" id="nba2k_importFile" accept=".json" onchange="importData(event, 'nba2k')">
          <button onclick="document.getElementById('nba2k_importFile').click()">üìÇ Import JSON</button>
        </label>
        <button onclick="backToMenu()">‚¨Ö Back to Menu</button>
      </div>
    </div>
    <div class="app-container">
      <div class="panel">
        <h2>Points Bank</h2>
        <label>Total Points Bank:
          <input type="number" id="nba2k_manualTotalPoints" value="1000" onchange="updatePointsBankDisplay('nba2k')">
        </label>
        <div class="result">Total Points Bank: <span id="nba2k_pointsBankDisplay">1000</span></div>
      </div>

      <div class="panel">
        <h2>Bonus Multipliers</h2>
        <label>Game Result:
          <select id="nba2k_gameResult" onchange="toggleOTBox('nba2k')">
            <option value="win">Win</option>
            <option value="otwin">OT Win</option>
            <option value="lose">Lose</option>
            <option value="otlose">OT Lose</option>
          </select>
        </label>
        <div id="nba2k_otCountBox" style="display:none;">
          <label>Overtime Count (1‚Äì6):
            <input type="number" id="nba2k_otCount" min="1" max="6" value="1">
          </label>
        </div>
        <label>Opponent Type:
          <select id="nba2k_opponentType">
            <option value="1">Easy Opponent</option>
            <option value="1.25">Normal Opponent</option>
            <option value="1.5">Hard Opponent</option>
            <option value="1.75">1st in Conference</option>
            <option value="2">1st/2nd in League</option>
            <option value="3">All-Star Game</option>
          </select>
        </label>
        <label>Team Last Season:
          <select id="nba2k_teamHistory">
            <option value="1">Did Not Make Playoffs</option>
            <option value="1.25">1st Round</option>
            <option value="1.5">2nd Round</option>
            <option value="1.75">Semifinalist</option>
            <option value="1.9">Finalist</option>
            <option value="2">Defending Champions</option>
          </select>
        </label>
        <button onclick="toggleMultiplierInfo('nba2k')">‚ÑπÔ∏è Explanation</button>
        <div id="nba2k_multiplierInfo" style="display:none; margin-top:10px;">
          <p><strong>Game Result:</strong> Win √ó1.5, OT Win adds +0.1 per OT (max 6), OT Lose √ó1.25</p>
          <p><strong>Opponent:</strong> Easy√ó1, Normal√ó1.25, Hard√ó1.5, 1st in Conf√ó1.75, Top‚Äë2√ó2, All‚ÄëStar√ó3</p>
          <p><strong>Team History:</strong> No Playoffs√ó1, 1stRn√ó1.25, 2ndRn√ó1.5, Semis√ó1.75, Finals√ó1.9, Champs√ó2</p>
        </div>
        <label><input type="checkbox" id="nba2k_disablePointAdd"> Don't add to total bank</label>
      </div>

      <div class="panel">
        <h2>Game Stats</h2>
        <form id="nba2k_statsForm" onsubmit="event.preventDefault(); calculateTotalPoints('nba2k');">
          <label>Points (gpts): <input type="number" name="gpts" value="0"></label>
          <label>Rebounds (greb): <input type="number" name="greb" value="0"></label>
          <label>Assists (gast): <input type="number" name="gast" value="0"></label>
          <label>Steals (gstl): <input type="number" name="gstl" value="0"></label>
          <label>Blocks (gblk): <input type="number" name="gblk" value="0"></label>
          <label>2PT Made (g2pt): <input type="number" name="g2pt" value="0"></label>
          <label>3PT Made (g3pt): <input type="number" name="g3pt" value="0"></label>
          <label>Free Throws (gfts): <input type="number" name="gfts" value="0"></label>
          <label>Turnovers (gtov): <input type="number" name="gtov" value="0"></label>
          <label>Fouls (gfls): <input type="number" name="gfls" value="0"></label>
          <label>+/- Score (gpm): <input type="number" name="gpm" value="0"></label>
          <label>Minutes (gm): <input type="number" name="gm" value="0"></label>
          <label>Base Points Increase: <input type="number" id="nba2k_basePointsIncrease" value="0"></label>
          <button type="submit">Calculate Points Earned</button>
        </form>
        <div class="result">Points Earned: <span id="nba2k_pointsEarned">0</span></div>
      </div>

      <div class="panel">
        <h2>Attribute Upgrade Cost</h2>
        <div>
          <h3>
            <label class="checkbox-container">
              <input type="checkbox" id="nba2k_useOffense" checked onchange="calculateAllUpgrades('nba2k')">
              <span class="checkmark"></span>
              Offense
            </label>
          </h3>
          <label>Current Rating: <input type="number" id="nba2k_offenseCurrent" value="60" onchange="calculateAllUpgrades('nba2k')"></label>
          <label>Target Rating: <input type="number" id="nba2k_offenseTarget" value="70" onchange="calculateAllUpgrades('nba2k')"></label>
          <div class="result">Cost: <span id="nba2k_offenseCost">0</span></div>
        </div>

        <div>
          <h3>
            <label class="checkbox-container">
              <input type="checkbox" id="nba2k_useDefense" checked onchange="calculateAllUpgrades('nba2k')">
              <span class="checkmark"></span>
              Defense
            </label>
          </h3>
          <label>Current Rating: <input type="number" id="nba2k_defenseCurrent" value="60" onchange="calculateAllUpgrades('nba2k')"></label>
          <label>Target Rating: <input type="number" id="nba2k_defenseTarget" value="70" onchange="calculateAllUpgrades('nba2k')"></label>
          <div class="result">Cost: <span id="nba2k_defenseCost">0</span></div>
        </div>

        <div>
          <h3>
            <label class="checkbox-container">
              <input type="checkbox" id="nba2k_useAthletic" checked onchange="calculateAllUpgrades('nba2k')">
              <span class="checkmark"></span>
              Athleticism
            </label>
          </h3>
          <label>Current Rating: <input type="number" id="nba2k_athleticCurrent" value="60" onchange="calculateAllUpgrades('nba2k')"></label>
          <label>Target Rating: <input type="number" id="nba2k_athleticTarget" value="70" onchange="calculateAllUpgrades('nba2k')"></label>
          <div class="result">Cost: <span id="nba2k_athleticCost">0</span></div>
        </div>

        <div>
          <h3>
            <label class="checkbox-container">
              <input type="checkbox" id="nba2k_useMental" checked onchange="calculateAllUpgrades('nba2k')">
              <span class="checkmark"></span>
              Mental
            </label>
          </h3>
          <label>Current Rating: <input type="number" id="nba2k_mentalCurrent" value="60" onchange="calculateAllUpgrades('nba2k')"></label>
          <label>Target Rating: <input type="number" id="nba2k_mentalTarget" value="70" onchange="calculateAllUpgrades('nba2k')"></label>
          <div class="result">Cost: <span id="nba2k_mentalCost">0</span></div>
        </div>

        <button onclick="calculateAllUpgrades('nba2k')">Calculate All Upgrade Costs</button>
        <div class="result" id="nba2k_upgradeSummary"></div>
        <button onclick="confirmUpgrade('nba2k')">Confirm Upgrade</button>
        <label>Price Multiplier:
          <select id="nba2k_priceMultiplier" onchange="calculateAllUpgrades('nba2k')">
            <option value="1">Not Valuable (1√ó)</option>
            <option value="2">Valuable (2√ó)</option>
            <option value="3">Very Valuable (3√ó)</option>
          </select>
        </label>
      </div>
    </div>
  </div>

  <!-- BBGM App Section -->
  <div class="app-section" id="bbgmApp">
    <div class="top-bar">
      <h1>BasketballGM MyCareer Tool</h1>
      <div>
        <button onclick="exportData('bbgm')">üíæ Export JSON</button>
        <label>
          <input type="file" class="file-input" id="bbgm_importFile" accept=".json" onchange="importData(event, 'bbgm')">
          <button onclick="document.getElementById('bbgm_importFile').click()">üìÇ Import JSON</button>
        </label>
        <button onclick="backToMenu()">‚¨Ö Back to Menu</button>
      </div>
    </div>
    <div class="app-container">
      <div class="panel">
        <h2>Points Bank</h2>
        <label>Total Points Bank:
          <input type="number" id="bbgm_manualTotalPoints" value="1000" onchange="updatePointsBankDisplay('bbgm')">
        </label>
        <div class="result">Total Points Bank: <span id="bbgm_pointsBankDisplay">1000</span></div>
      </div>

      <div class="panel">
        <h2>Bonus Multipliers</h2>
        <label>Game Result:
          <select id="bbgm_gameResult" onchange="toggleOTBox('bbgm')">
            <option value="win">Win</option>
            <option value="otwin">OT Win</option>
            <option value="lose">Lose</option>
            <option value="otlose">OT Lose</option>
          </select>
        </label>
        <div id="bbgm_otCountBox" style="display:none;">
          <label>Overtime Count (1‚Äì6):
            <input type="number" id="bbgm_otCount" min="1" max="6" value="1">
          </label>
        </div>
        <label>Opponent Type:
          <select id="bbgm_opponentType">
            <option value="1">Easy Opponent</option>
            <option value="1.25">Normal Opponent</option>
            <option value="1.5">Hard Opponent</option>
            <option value="1.75">1st in Conference</option>
            <option value="2">1st/2nd in League</option>
            <option value="3">All-Star Game</option>
          </select>
        </label>
        <label>Team Last Season:
          <select id="bbgm_teamHistory">
            <option value="1">Did Not Make Playoffs</option>
            <option value="1.25">1st Round</option>
            <option value="1.5">2nd Round</option>
            <option value="1.75">Semifinalist</option>
            <option value="1.9">Finalist</option>
            <option value="2">Defending Champions</option>
          </select>
        </label>
        <button onclick="toggleMultiplierInfo('bbgm')">‚ÑπÔ∏è Explanation</button>
        <div id="bbgm_multiplierInfo" style="display:none; margin-top:10px;">
          <p><strong>Game Result:</strong> Win √ó1.5, OT Win adds +0.1 per OT (max 6), OT Lose √ó1.25</p>
          <p><strong>Opponent:</strong> Easy√ó1, Normal√ó1.25, Hard√ó1.5, 1st in Conf√ó1.75, Top‚Äë2√ó2, All‚ÄëStar√ó3</p>
          <p><strong>Team History:</strong> No Playoffs√ó1, 1stRn√ó1.25, 2ndRn√ó1.5, Semis√ó1.75, Finals√ó1.9, Champs√ó2</p>
        </div>
        <label><input type="checkbox" id="bbgm_disablePointAdd"> Don't add to total bank</label>
      </div>

      <div class="panel">
        <h2>Game Stats</h2>
        <form id="bbgm_statsForm" onsubmit="event.preventDefault(); calculateTotalPoints('bbgm');">
          <label>Points (gpts): <input type="number" name="gpts" value="0"></label>
          <label>Rebounds (greb): <input type="number" name="greb" value="0"></label>
          <label>Assists (gast): <input type="number" name="gast" value="0"></label>
          <label>Steals (gstl): <input type="number" name="gstl" value="0"></label>
          <label>Blocks (gblk): <input type="number" name="gblk" value="0"></label>
          <label>2PT Made (g2pt): <input type="number" name="g2pt" value="0"></label>
          <label>3PT Made (g3pt): <input type="number" name="g3pt" value="0"></label>
          <label>Free Throws (gfts): <input type="number" name="gfts" value="0"></label>
          <label>Turnovers (gtov): <input type="number" name="gtov" value="0"></label>
          <label>Fouls (gfls): <input type="number" name="gfls" value="0"></label>
          <label>+/- Score (gpm): <input type="number" name="gpm" value="0"></label>
          <label>Minutes (gm): <input type="number" name="gm" value="0"></label>
          <label>Base Points Increase: <input type="number" id="bbgm_basePointsIncrease" value="0"></label>
          <button type="submit">Calculate Points Earned</button>
        </form>
        <div class="result">Points Earned: <span id="bbgm_pointsEarned">0</span></div>
      </div>

      <div class="panel">
        <h2>Attribute Upgrade Cost</h2>
        <div>
          <h3>
            <label class="checkbox-container">
              <input type="checkbox" id="bbgm_useOffense" checked onchange="calculateAllUpgrades('bbgm')">
              <span class="checkmark"></span>
              Offense
            </label>
          </h3>
          <label>Current Rating: <input type="number" id="bbgm_offenseCurrent" value="60" onchange="calculateAllUpgrades('bbgm')"></label>
          <label>Target Rating: <input type="number" id="bbgm_offenseTarget" value="70" onchange="calculateAllUpgrades('bbgm')"></label>
          <div class="result">Cost: <span id="bbgm_offenseCost">0</span></div>
        </div>

        <div>
          <h3>
            <label class="checkbox-container">
              <input type="checkbox" id="bbgm_useAthletic" checked onchange="calculateAllUpgrades('bbgm')">
              <span class="checkmark"></span>
              Athleticism
            </label>
          </h3>
          <label>Current Rating: <input type="number" id="bbgm_athleticCurrent" value="60" onchange="calculateAllUpgrades('bbgm')"></label>
          <label>Target Rating: <input type="number" id="bbgm_athleticTarget" value="70" onchange="calculateAllUpgrades('bbgm')"></label>
          <div class="result">Cost: <span id="bbgm_athleticCost">0</span></div>
        </div>

        <div>
          <h3>
            <label class="checkbox-container">
              <input type="checkbox" id="bbgm_useSkill" checked onchange="calculateAllUpgrades('bbgm')">
              <span class="checkmark"></span>
              Skill
            </label>
          </h3>
          <label>Current Rating: <input type="number" id="bbgm_skillCurrent" value="60" onchange="calculateAllUpgrades('bbgm')"></label>
          <label>Target Rating: <input type="number" id="bbgm_skillTarget" value="70" onchange="calculateAllUpgrades('bbgm')"></label>
          <div class="result">Cost: <span id="bbgm_skillCost">0</span></div>
        </div>

        <button onclick="calculateAllUpgrades('bbgm')">Calculate All Upgrade Costs</button>
        <div class="result" id="bbgm_upgradeSummary"></div>
        <button onclick="confirmUpgrade('bbgm')">Confirm Upgrade</button>
        <label>Price Multiplier:
          <select id="bbgm_priceMultiplier" onchange="calculateAllUpgrades('bbgm')">
            <option value="1">Not Valuable (1√ó)</option>
            <option value="2">Valuable (2√ó)</option>
            <option value="3">Very Valuable (3√ó)</option>
          </select>
        </label>
      </div>
    </div>
  </div>

  <script>
    // Define point values and upgrade costs for both apps
    const appData = {
      nba2k: {
        pointValues: {
          gpts: 2, greb: 5, gast: 5, gstl: 10, gblk: 10,
          g2pt: 2, g3pt: 3, gfts: 1, gtov: -2, gfls: -1, gpm: 5, gm: 1
        },
        upgradeCostPerPoint: {
          offense: r => (r < 60 ? 25 : r <= 79 ? 40 : r <= 89 ? 70 : r <= 94 ? 125 : 50),
          mental: r => (r < 60 ? 25 : r <= 79 ? 37 : r <= 89 ? 68 : r <= 94 ? 120 : 45),
          defense: r => (r < 60 ? 25 : r <= 79 ? 51 : r <= 89 ? 85 : r <= 94 ? 135 : 75),
          athleticism: r => (r < 60 ? 30 : r <= 79 ? 65 : r <= 89 ? 105 : r <= 94 ? 155 : 100)
        },
        upgradeCategories: [
          { key: 'offense', useId: 'useOffense', baseMultiplier: 1.25 },
          { key: 'defense', useId: 'useDefense', baseMultiplier: 1.5 },
          { key: 'athletic', useId: 'useAthletic', baseMultiplier: 2.5 },
          { key: 'mental', useId: 'useMental', baseMultiplier: 2.0 }
        ]
      },
      bbgm: {
        pointValues: {
          gpts: 2, greb: 5, gast: 5, gstl: 10, gblk: 10,
          g2pt: 2, g3pt: 3, gfts: 1, gtov: -2, gfls: -1, gpm: 5, gm: 1
        },
        upgradeCostPerPoint: {
          offense: r => (r < 60 ? 95 : r <= 79 ? 115 : r <= 89 ? 134 : r <= 94 ? 168 : 209),
          skill: r => (r < 60 ? 75 : r <= 79 ? 120 : r <= 89 ? 157 : r <= 94 ? 234 : 347),
          athleticism: r => (r < 60 ? 64 : r <= 118 ? 65 : r <= 89 ? 147 : r <= 94 ? 217 : 274)
        },
        upgradeCategories: [
          { key: 'offense', useId: 'useOffense', baseMultiplier: 1.25 },
          { key: 'athletic', useId: 'useAthletic', baseMultiplier: 2.5 },
          { key: 'skill', useId: 'useSkill', baseMultiplier: 3.0 }
        ]
      }
    };

    // Helper function to get elements for a specific app
    function getAppElements(appId) {
      const prefix = `${appId}_`;
      return {
        manualTotalPoints: document.getElementById(`${prefix}manualTotalPoints`),
        pointsBankDisplay: document.getElementById(`${prefix}pointsBankDisplay`),
        gameResult: document.getElementById(`${prefix}gameResult`),
        otCountBox: document.getElementById(`${prefix}otCountBox`),
        otCount: document.getElementById(`${prefix}otCount`),
        opponentType: document.getElementById(`${prefix}opponentType`),
        teamHistory: document.getElementById(`${prefix}teamHistory`),
        multiplierInfo: document.getElementById(`${prefix}multiplierInfo`),
        disablePointAdd: document.getElementById(`${prefix}disablePointAdd`),
        statsForm: document.getElementById(`${prefix}statsForm`),
        basePointsIncrease: document.getElementById(`${prefix}basePointsIncrease`),
        pointsEarned: document.getElementById(`${prefix}pointsEarned`),
        upgradeSummary: document.getElementById(`${prefix}upgradeSummary`),
        priceMultiplier: document.getElementById(`${prefix}priceMultiplier`),
        // Upgrade attribute elements (dynamic based on appData.upgradeCategories)
        getUpgradeElements: (categoryKey) => ({
          use: document.getElementById(`${prefix}${appData[appId].upgradeCategories.find(c => c.key === categoryKey).useId}`),
          current: document.getElementById(`${prefix}${categoryKey}Current`),
          target: document.getElementById(`${prefix}${categoryKey}Target`),
          costDisplay: document.getElementById(`${prefix}${categoryKey}Cost`)
        })
      };
    }

    // Toggles dark mode for the entire body
    function toggleDarkMode() {
      document.body.classList.toggle('light-mode');
      saveToLocal('darkMode', document.body.classList.contains('light-mode'));
    }

    // Toggles the overtime count input box visibility
    function toggleOTBox(appId) {
      const elements = getAppElements(appId);
      elements.otCountBox.style.display =
        elements.gameResult.value === "otwin" ? "block" : "none";
    }

    // Toggles the explanation for bonus multipliers
    function toggleMultiplierInfo(appId) {
      const elements = getAppElements(appId);
      const info = elements.multiplierInfo;
      info.style.display = info.style.display === "none" ? "block" : "none";
    }

    // Updates the displayed points bank value
    function updatePointsBankDisplay(appId) {
      const elements = getAppElements(appId);
      elements.pointsBankDisplay.innerText = parseInt(elements.manualTotalPoints.value) || 0;
    }

    // Calculates points earned from game stats
    function calculateTotalPoints(appId) {
      const elements = getAppElements(appId);
      const appSpecificData = appData[appId];
      const form = elements.statsForm;
      let earned = 0;

      for (let key in appSpecificData.pointValues) {
        earned += (parseInt(form[key].value) || 0) * appSpecificData.pointValues[key];
      }

      const baseIncrease = parseInt(elements.basePointsIncrease.value) || 0;
      earned += baseIncrease;

      const result = elements.gameResult.value;
      const opp = parseFloat(elements.opponentType.value);
      const team = parseFloat(elements.teamHistory.value);
      const disable = elements.disablePointAdd.checked;

      let multiplier = 1;
      if (result === "win") multiplier = 1.5;
      else if (result === "otwin") {
        const ot = Math.min(6, parseInt(elements.otCount.value) || 1);
        multiplier = 1.5 + (0.1 * ot);
      } else if (result === "otlose") multiplier = 1.25;

      const total = Math.round(earned * multiplier * opp * team);
      const bankInput = elements.manualTotalPoints;
      const newTotal = disable ? parseInt(bankInput.value) : parseInt(bankInput.value) + total;

      if (!disable) bankInput.value = newTotal;
      elements.pointsBankDisplay.innerText = newTotal;
      elements.pointsEarned.innerText = total;

      saveCurrentAppData(appId); // Save state after calculation
    }

    // Calculates total cost for attribute upgrades
    function calculateAllUpgrades(appId) {
      const elements = getAppElements(appId);
      const appSpecificData = appData[appId];

      let totalCost = 0;
      const bank = parseInt(elements.manualTotalPoints.value);
      const priceMultiplier = parseFloat(elements.priceMultiplier.value);

      for (let category of appSpecificData.upgradeCategories) {
        const upgradeElements = elements.getUpgradeElements(category.key);
        const current = parseInt(upgradeElements.current.value);
        const target = parseInt(upgradeElements.target.value);
        const display = upgradeElements.costDisplay;
        const useCategory = upgradeElements.use.checked;

        if (!useCategory) {
          display.innerText = "Ignored";
          continue;
        }

        if (isNaN(current) || isNaN(target) || current >= target) {
          display.innerText = "Invalid";
          continue;
        }

        let cost = 0;
        for (let i = current + 1; i <= target; i++) {
          let baseCost = appSpecificData.upgradeCostPerPoint[category.key](i);
          cost += baseCost * category.baseMultiplier * priceMultiplier;
        }

        display.innerText = Math.round(cost);
        totalCost += cost;
      }

      const summary = elements.upgradeSummary;
      summary.innerHTML = `
        Total Upgrade Cost: ${Math.round(totalCost)}<br>
        Points Before Upgrade: ${bank}<br>
        Points After Upgrade: ${bank - Math.round(totalCost)}
      `;
      summary.dataset.totalCost = Math.round(totalCost);

      saveCurrentAppData(appId); // Save state after calculation
    }

    // Confirms and applies the attribute upgrade cost
    function confirmUpgrade(appId) {
      const elements = getAppElements(appId);
      const cost = parseInt(elements.upgradeSummary.dataset.totalCost || "0");
      const bankInput = elements.manualTotalPoints;
      const currentPoints = parseInt(bankInput.value);

      if (cost > currentPoints) {
        // Use a custom message box instead of alert
        showCustomAlert("Not enough points for upgrade!");
        return;
      }

      bankInput.value = currentPoints - cost;
      elements.pointsBankDisplay.innerText = bankInput.value;
      showCustomAlert("Upgrade applied!");

      saveCurrentAppData(appId); // Save state after upgrade
    }

    // Custom alert function (replaces window.alert)
    function showCustomAlert(message) {
      const alertBox = document.createElement('div');
      alertBox.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--section);
        color: var(--text);
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0,0,0,0.7);
        z-index: 1000;
        text-align: center;
        max-width: 80vw;
      `;
      alertBox.innerHTML = `
        <p>${message}</p>
        <button onclick="this.parentNode.remove()" style="margin-top: 15px; background: var(--accent); color: black;">OK</button>
      `;
      document.body.appendChild(alertBox);
    }

    // Exports current app data to a JSON file
    function exportData(appId) {
      const elements = getAppElements(appId);
      const data = {
        app: appId,
        totalPoints: elements.manualTotalPoints.value,
        gameResult: elements.gameResult.value,
        otCount: elements.otCount.value,
        opponentType: elements.opponentType.value,
        teamHistory: elements.teamHistory.value,
        disablePointAdd: elements.disablePointAdd.checked,
        basePointsIncrease: elements.basePointsIncrease.value,
        stats: {},
        upgrade: {
          priceMultiplier: elements.priceMultiplier.value
        }
      };

      // Get stats form data
      const statsForm = elements.statsForm;
      for (let i = 0; i < statsForm.elements.length; i++) {
        const el = statsForm.elements[i];
        if (el.name && el.type !== 'submit') {
          data.stats[el.name] = el.value;
        }
      }

      // Get upgrade data dynamically based on app's categories
      appData[appId].upgradeCategories.forEach(category => {
        const upgradeElements = elements.getUpgradeElements(category.key);
        data.upgrade[category.key] = {
          current: upgradeElements.current.value,
          target: upgradeElements.target.value,
          use: upgradeElements.use.checked
        };
      });

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `${appId}_save.json`;
      link.click();
      URL.revokeObjectURL(link.href);
    }

    // Imports data from a JSON file
    function importData(event, targetAppId) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = JSON.parse(e.target.result);
          if (data.app !== targetAppId) {
            showCustomAlert(`This file is for ${data.app.toUpperCase()} and cannot be imported into ${targetAppId.toUpperCase()}.`);
            return;
          }

          const elements = getAppElements(targetAppId);

          elements.manualTotalPoints.value = data.totalPoints || 0;
          elements.gameResult.value = data.gameResult || 'win';
          elements.otCount.value = data.otCount || 1;
          elements.opponentType.value = data.opponentType || '1';
          elements.teamHistory.value = data.teamHistory || '1';
          elements.disablePointAdd.checked = data.disablePointAdd || false;
          elements.basePointsIncrease.value = data.basePointsIncrease || 0;
          elements.priceMultiplier.value = data.upgrade.priceMultiplier || '1';

          // Populate stats form
          const statsForm = elements.statsForm;
          for (let key in data.stats) {
            if (statsForm[key]) {
              statsForm[key].value = data.stats[key];
            }
          }

          // Populate upgrade attributes
          appData[targetAppId].upgradeCategories.forEach(category => {
            const upgradeElements = elements.getUpgradeElements(category.key);
            const loadedUpgrade = data.upgrade[category.key];
            if (loadedUpgrade) {
              upgradeElements.current.value = loadedUpgrade.current;
              upgradeElements.target.value = loadedUpgrade.target;
              upgradeElements.use.checked = loadedUpgrade.use;
            }
          });

          // Trigger calculations to update displays
          toggleOTBox(targetAppId);
          updatePointsBankDisplay(targetAppId);
          calculateTotalPoints(targetAppId);
          calculateAllUpgrades(targetAppId);

          saveCurrentAppData(targetAppId); // Save state after import
          showCustomAlert("Data imported successfully!");

        } catch (err) {
          showCustomAlert("Invalid file format or data structure.");
          console.error("Import error:", err);
        }
      };
      reader.readAsText(file);
    }

    // Shows the selected app section and hides others
    function showApp(appId) {
      document.getElementById('mainMenu').classList.remove('active');
      document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
      document.getElementById(appId + 'App').classList.add('active');
      saveToLocal('activeApp', appId); // Save which app is active

      // Load data for the newly active app
      loadAppData(appId);
    }

    // Returns to the main menu
    function backToMenu() {
      document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
      document.getElementById('mainMenu').classList.add('active');
      localStorage.removeItem('mycareer_activeApp'); // Clear active app from local storage
    }

    // Redirects to BBGM website
    function redirectToBBGM() {
      window.open("https://play.basketball-gm.com/", "_blank");
    }

    // Saves a key-value pair to local storage
    function saveToLocal(key, value) {
      localStorage.setItem('mycareer_' + key, JSON.stringify(value));
    }

    // Loads a key-value pair from local storage
    function loadFromLocal(key) {
      try {
        const item = localStorage.getItem('mycareer_' + key);
        return item ? JSON.parse(item) : null;
      } catch (e) {
        console.error("Error parsing localStorage item:", key, e);
        return null;
      }
    }

    // Saves all current data for the active app
    function saveCurrentAppData(appId) {
      const elements = getAppElements(appId);
      const data = {
        totalPoints: elements.manualTotalPoints.value,
        gameResult: elements.gameResult.value,
        otCount: elements.otCount.value,
        opponentType: elements.opponentType.value,
        teamHistory: elements.teamHistory.value,
        disablePointAdd: elements.disablePointAdd.checked,
        basePointsIncrease: elements.basePointsIncrease.value,
        priceMultiplier: elements.priceMultiplier.value,
        stats: {},
        upgrade: {}
      };

      // Get stats form data
      const statsForm = elements.statsForm;
      for (let i = 0; i < statsForm.elements.length; i++) {
        const el = statsForm.elements[i];
        if (el.name && el.type !== 'submit') {
          data.stats[el.name] = el.value;
        }
      }

      // Get upgrade data dynamically based on app's categories
      appData[appId].upgradeCategories.forEach(category => {
        const upgradeElements = elements.getUpgradeElements(category.key);
        data.upgrade[category.key] = {
          current: upgradeElements.current.value,
          target: upgradeElements.target.value,
          use: upgradeElements.use.checked
        };
      });

      saveToLocal(`data_${appId}`, data);
    }

    // Loads all data for a specific app into its fields
    function loadAppData(appId) {
      const data = loadFromLocal(`data_${appId}`);
      if (data) {
        const elements = getAppElements(appId);

        elements.manualTotalPoints.value = data.totalPoints || 0;
        elements.gameResult.value = data.gameResult || 'win';
        elements.otCount.value = data.otCount || 1;
        elements.opponentType.value = data.opponentType || '1';
        elements.teamHistory.value = data.teamHistory || '1';
        elements.disablePointAdd.checked = data.disablePointAdd || false;
        elements.basePointsIncrease.value = data.basePointsIncrease || 0;
        elements.priceMultiplier.value = data.priceMultiplier || '1';

        // Populate stats form
        const statsForm = elements.statsForm;
        for (let key in data.stats) {
          if (statsForm[key]) {
            statsForm[key].value = data.stats[key];
          }
        }

        // Populate upgrade attributes
        appData[appId].upgradeCategories.forEach(category => {
          const upgradeElements = elements.getUpgradeElements(category.key);
          const loadedUpgrade = data.upgrade[category.key];
          if (loadedUpgrade) {
            upgradeElements.current.value = loadedUpgrade.current;
            upgradeElements.target.value = loadedUpgrade.target;
            upgradeElements.use.checked = loadedUpgrade.use;
          }
        });

        // Trigger calculations to update displays
        toggleOTBox(appId);
        updatePointsBankDisplay(appId);
        calculateTotalPoints(appId); // Recalculate points earned
        calculateAllUpgrades(appId); // Recalculate upgrade costs
      } else {
        // If no data, reset to default values and update displays
        const elements = getAppElements(appId);
        elements.manualTotalPoints.value = 1000; // Default
        elements.pointsBankDisplay.innerText = 1000;
        elements.pointsEarned.innerText = 0;
        elements.upgradeSummary.innerHTML = '';
        // Reset form fields to their initial HTML values
        if (elements.statsForm) elements.statsForm.reset();
        appData[appId].upgradeCategories.forEach(category => {
          const upgradeElements = elements.getUpgradeElements(category.key);
          upgradeElements.current.value = 60;
          upgradeElements.target.value = 70;
          upgradeElements.use.checked = true;
          upgradeElements.costDisplay.innerText = 0;
        });
        toggleOTBox(appId); // Ensure OT box is hidden by default
      }
    }

    // Initial load on page load
    window.onload = function() {
      const activeApp = loadFromLocal('activeApp');
      if (activeApp) {
        showApp(activeApp);
      } else {
        document.getElementById('mainMenu').classList.add('active');
      }

      const isLightMode = loadFromLocal('darkMode');
      if (isLightMode) {
        document.body.classList.add('light-mode');
      }

      // Generate background particles
      for (let i = 0; i < 100; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.left = Math.random() * 100 + 'vw';
        p.style.top = Math.random() * -100 + 'vh';
        p.style.animationDuration = (5 + Math.random() * 10) + 's';
        document.getElementById('space-bg').appendChild(p);
      }
    };
  </script>
</body>
</html>
